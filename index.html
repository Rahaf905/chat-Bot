<!-- Floating Chat Bubble -->
<div id="chat-icon">
    <img src="https://i.pinimg.com/736x/1e/b0/5f/1eb05f325ec50a15c8b045f3428d6d5e.jpg"
         alt="Chatbot Icon"
         style="width: 100%; height: 100%; border-radius: 50%;">
    <div id="moving-message" class="moving-message">Hello!</div>
</div>

<!-- Chat Window -->
<div id="chat-container">
    <div class="chat-header">
        <h3>RevolveAI Assistant</h3>
        <span id="close-chat">X</span>
    </div>
    <div class="chat-box" id="chat-box">
        <div class="chat-message bot">Hello! How can I assist you in your business today?</div>
    </div>
    <!-- Quick Questions -->
    <div class="quick-questions">
        <button onclick="sendQuickMessage('How can RevolveAI help my business?')">How can RevolveAI help my business?</button>
        <button onclick="sendQuickMessage('What are the best strategies for growing a startup?')">What are the best strategies for growing a startup?</button>
        <button onclick="sendQuickMessage('Can you help me automate my daily tasks?')">Can you help me automate my daily tasks?</button>
    </div>
    <!-- Chat Footer -->
    <div class="chat-footer">
        <input type="text" id="user-input" placeholder="Type a message..." onkeypress="handleEnter(event)">
        <button id="send-btn">Send</button>
    </div>
</div>

<style>
    /* Apply Standard System Font */
    * {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
    }

    /* Ensure Transparent Background */
    body, html {
        background: transparent !important;
    }

    html, body {
        overflow: auto !important;
        height: auto !important;
    }

    /* Floating Chat Icon */
    #chat-icon {
        position: fixed;
        bottom: 15px;
        right: 10px;
        width: 55px;
        height: 55px;
        cursor: pointer;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
        z-index: 999;
        overflow: hidden;
        border-radius: 50%;
    }

    /* Chat Container */
    #chat-container {
        display: none;
        position: fixed;
        bottom: 80px;
        right: 5px;
        width: 350px;
        height: 500px;
        overflow-y: auto;
        border-radius: 12px;
        background-color: rgba(255, 255, 255, 0.9);
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        flex-direction: column;
        overflow: hidden;
        z-index: 1000;
        border: 1px solid rgba(221, 221, 221, 0.5);
        pointer-events: none;
    }

    /* When chatbot is active */
    #chat-container.active {
        display: flex;
        pointer-events: auto;
    }

    /* Ensure chatbot does not interfere with other buttons */
    button, a {
        pointer-events: auto !important;
        z-index: 2000 !important;
    }
</style>

<!-- JavaScript for Chatbot -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const chatIcon = document.getElementById("chat-icon");
    const chatContainer = document.getElementById("chat-container");
    const closeChat = document.getElementById("close-chat");

    if (!chatIcon || !chatContainer || !closeChat) {
        console.error("❌ Chatbot elements NOT found in DOM!");
        return;
    }

    function toggleChat(event) {
        event?.stopPropagation(); // Stop interference with other elements

        if (chatContainer.classList.contains("active")) {
            chatContainer.classList.remove("active");
            chatContainer.style.pointerEvents = "none"; // Prevent chatbot from blocking clicks
            console.log("🔴 Chatbot closed");
        } else {
            chatContainer.classList.add("active");
            chatContainer.style.pointerEvents = "auto"; // Enable chatbot
            console.log("🟢 Chatbot opened");
        }
    }

    // Attach event listeners
    chatIcon.addEventListener("click", function (event) {
        console.log("🟢 Chat icon clicked!");
        toggleChat(event);
    });

    closeChat.addEventListener("click", function (event) {
        console.log("🔴 Chat close button clicked!");
        toggleChat(event);
    });

    // Close chatbot when clicking outside of it
    document.addEventListener("click", function (event) {
        if (!chatContainer.contains(event.target) && !chatIcon.contains(event.target)) {
            chatContainer.classList.remove("active");
            chatContainer.style.pointerEvents = "none";
            console.log("🔴 Chatbot closed (clicked outside)");
        }
    });

    // Ensure chatbot closes properly on mobile
    document.addEventListener("touchstart", function (event) {
        if (!chatContainer.contains(event.target) && !chatIcon.contains(event.target)) {
            chatContainer.classList.remove("active");
            chatContainer.style.pointerEvents = "none";
            console.log("🔴 Chatbot closed (mobile touch)");
        }
    }, { passive: true });

    console.log("✅ Chatbot script loaded successfully!");
});

// Function to send a message to the chatbot API
function sendMessage(message = null) {
    const userInputField = document.getElementById("user-input");
    const userInput = message || userInputField.value.trim();
    if (!userInput) return;

    displayMessage(userInput, "user");

    fetch("https://chatbot-backend-cesm.onrender.com/chat", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ message: userInput })
    })
    .then(res => res.json())
    .then(data => {
        displayMessage(data.response || "⚠️ Error: No response from AI.", "bot");
    })
    .catch(() => {
        displayMessage("❌ Error: Unable to reach the API.", "bot");
    });

    userInputField.value = "";
}

// Function to handle quick questions
function sendQuickMessage(message) {
    sendMessage(message);
}

// Function to display messages
function displayMessage(message, sender) {
    const chatBox = document.getElementById("chat-box");
    const messageDiv = document.createElement("div");
    messageDiv.className = `chat-message ${sender}`;
    messageDiv.textContent = message;
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
}

// Function to handle pressing Enter to send a message
function handleEnter(event) {
    if (event.key === "Enter") {
        event.preventDefault();
        sendMessage();
    }
}

document.getElementById("user-input").addEventListener("keypress", handleEnter);
document.getElementById("send-btn").addEventListener("click", () => sendMessage());
</script>
